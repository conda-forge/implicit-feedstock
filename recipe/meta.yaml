{% set implicit_proc_type = "cpu" %}
{% set name = "implicit" %}
{% set version = "0.6.2" %}
{% set sha256 = "abf1331b20222cdbe83fba66c1ee777795af0c6cd6862c0aa3ca4aee1041e888" %}

{% set implicit_proc_type = "cpu" if cuda_compiler_version == "None" else "gpu" %}  # [linux64]
{% set implicit_proc_type = "cpu" %}                                                # [not linux64]


package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://pypi.io/packages/source/{{ name[0] }}/{{ name }}/{{ name }}-{{ version }}.tar.gz
  sha256: {{ sha256 }}
  patches:
    - patches/0001-thrust.patch

build:
  number: 0
  skip: true  # [py2k]
  skip: true  # [win and cuda_compiler_version != "None"]

outputs:
  - name: implicit-proc
    version: {{ version }}
    build:
      number: 0
      string: {{ implicit_proc_type }}
    test:
      commands:
        - exit 0
    about:
      home: https://github.com/conda-forge/implicit-feedstock
      license: BSD-3-Clause
      license_family: BSD
      summary: A meta-package to select CPU or GPU implicit build.

  - name: implicit
    build:
      number: 0
      script:
        - python -m pip install . --no-deps -vv

    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('cuda') }}  # [linux64 and cuda_compiler_version != "None"]
      host:
        - python x.x
        - pip
        - wheel
        - setuptools
        - ninja
        - cmake
        - scikit-build >=0.13.1
        - cython >=0.24
        # implicit cimports BLAS from scipy
        - scipy >=0.16
      run:
        - python x.x
        - {{ pin_compatible('numpy') }}
        - {{ pin_compatible('scipy') }}
        - tqdm >=4.27
      run_constrained:
        - implicit-proc * {{ implicit_proc_type }}

    test:
      imports:
        - implicit
        - implicit.cpu._als

    about:
      home: http://github.com/benfred/implicit/
      license: MIT
      license_family: MIT
      license_file: LICENSE
      summary: Fast Python Collaborative Filtering for Implicit Datasets.
      description: |
        This project provides fast Python implementations of the algorithms
        described in the paper Collaborative Filtering for Implicit Feedback
        Datasets and in Applications of the Conjugate Gradient Method
        for Implicit Feedback Collaborative Filtering
      doc_url: http://implicit.readthedocs.io/
      dev_url: http://github.com/benfred/implicit/

about:
  home: http://github.com/benfred/implicit/
  license: MIT
  license_family: MIT
  license_file: LICENSE
  summary: Fast Python Collaborative Filtering for Implicit Datasets.
  description: |
    This project provides fast Python implementations of the algorithms
    described in the paper Collaborative Filtering for Implicit Feedback
    Datasets and in Applications of the Conjugate Gradient Method
    for Implicit Feedback Collaborative Filtering
  doc_url: http://implicit.readthedocs.io/
  dev_url: http://github.com/benfred/implicit/

extra:
  recipe-maintainers:
    - rth
    - benfred
